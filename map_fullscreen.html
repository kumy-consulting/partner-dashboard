<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Stations IoT - Agriculture Guin√©e</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ubuntu', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            padding: 12px 20px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            text-align: center;
            grid-column: 2;
            justify-content: center;
        }

        .header-title h1 {
            font-size: 18px;
            color: #026B5D;
            font-weight: 700;
            margin: 0;
            white-space: nowrap;
        }

        .header-subtitle {
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
        }

        .header-divider {
            width: 2px;
            height: 24px;
            background: #e0e0e0;
        }

        .back-btn {
            padding: 8px 16px;
            background: #026B5D;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            justify-self: start;
            grid-column: 1;
            white-space: nowrap;
        }

        .back-btn:hover {
            background: #027f6a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(2, 107, 93, 0.3);
        }

        .legend-overlay {
            position: absolute;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            max-width: 250px;
        }

        .legend-title {
            font-weight: 700;
            color: #026B5D;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 12px;
        }

        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .legend-icon.active { background: #27ae60; }
        .legend-icon.warning { background: #f39c12; }
        .legend-icon.critical { background: #e74c3c; }

        .stats-overlay {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            min-width: 200px;
        }

        .stat-item {
            margin: 10px 0;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #026B5D;
        }

        .stat-label {
            font-size: 11px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        /* Custom marker popup */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .station-popup {
            padding: 5px;
            min-width: 200px;
        }

        .station-popup h3 {
            color: #026B5D;
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f4f3;
        }

        .station-info {
            font-size: 12px;
            line-height: 1.8;
            color: #333;
        }

        .station-info strong {
            color: #026B5D;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-active { background: #27ae60; color: white; }
        .status-warning { background: #f39c12; color: white; }
        .status-critical { background: #e74c3c; color: white; }

        /* Positionner les contr√¥les de zoom Leaflet √† droite */
        .leaflet-top.leaflet-left {
            left: auto !important;
            right: 20px;
            top: 80px;
        }

        .leaflet-control-zoom {
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .leaflet-control-zoom a {
            width: 36px;
            height: 36px;
            line-height: 36px;
            font-size: 20px;
            font-weight: bold;
        }

        /* Animation de scintillement pour les marqueurs */
        @keyframes pulse {
            0% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 0 rgba(39, 174, 96, 0.7);
            }
            50% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 8px rgba(39, 174, 96, 0);
            }
            100% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 0 rgba(39, 174, 96, 0);
            }
        }

        @keyframes pulse-warning {
            0% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 0 rgba(243, 156, 18, 0.7);
            }
            50% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 8px rgba(243, 156, 18, 0);
            }
            100% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 0 rgba(243, 156, 18, 0);
            }
        }

        @keyframes pulse-critical {
            0% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            50% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 8px rgba(231, 76, 60, 0);
            }
            100% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        .marker-pulse {
            animation: pulse 2s infinite;
        }

        .marker-pulse-warning {
            animation: pulse-warning 1.5s infinite;
        }

        .marker-pulse-critical {
            animation: pulse-critical 1s infinite;
        }

        @media (max-width: 768px) {
            .header-overlay {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                gap: 10px;
                padding: 15px;
            }

            .back-btn {
                grid-column: 1;
                grid-row: 1;
                justify-self: center;
            }

            .header-title {
                grid-column: 1;
                grid-row: 2;
            }

            .header-title h1 {
                font-size: 16px;
            }

            .stats-overlay {
                top: auto;
                bottom: 30px;
                right: 20px;
                left: auto;
            }

            .legend-overlay {
                display: none;
            }

            .leaflet-top.leaflet-left {
                top: 140px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-overlay">
        <a href="guinea_agriculture_dashboard.html" class="back-btn">‚Üê Retour</a>
        <div class="header-title">
            <h1>Carte des Stations IoT Agriculture</h1>
            <div class="header-divider"></div>
            <div class="header-subtitle">Syst√®me de Monitoring en Temps R√©el - R√©publique de Guin√©e</div>
        </div>
        <div></div>
    </div>

    <!-- Stats Overlay -->
    <div class="stats-overlay">
        <div class="stat-item">
            <div class="stat-value" id="totalStations">247</div>
            <div class="stat-label">Stations Actives</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" style="color: #27ae60;" id="activeStations">234</div>
            <div class="stat-label">En Ligne</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" style="color: #f39c12;" id="warningStations">10</div>
            <div class="stat-label">Alertes</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" style="color: #e74c3c;" id="criticalStations">3</div>
            <div class="stat-label">Critiques</div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend-overlay">
        <div class="legend-title">üìä L√©gende</div>
        <div class="legend-item">
            <div class="legend-icon active"></div>
            <span>Station Active (234)</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon warning"></div>
            <span>Alerte (10)</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon critical"></div>
            <span>Critique (3)</span>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map centered on Guinea with zoom constraints
        const map = L.map('map', {
            center: [9.9456, -9.6966],
            zoom: 7,
            minZoom: 6,
            maxZoom: 15,
            maxBounds: [
                [6.5, -16.0],  // Sud-Ouest de la Guin√©e
                [13.0, -6.0]   // Nord-Est de la Guin√©e
            ],
            maxBoundsViscosity: 0.5
        });

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            minZoom: 6,
            maxZoom: 15,
        }).addTo(map);

        // Custom marker icons avec animation de scintillement
        const createMarkerIcon = (color, animationClass) => {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div class="${animationClass}" style="
                    width: 24px;
                    height: 24px;
                    background: ${color};
                    border: 3px solid white;
                    border-radius: 50%;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    cursor: pointer;
                    transition: transform 0.2s;
                "></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -12]
            });
        };

        const activeIcon = createMarkerIcon('#27ae60', 'marker-pulse');
        const warningIcon = createMarkerIcon('#f39c12', 'marker-pulse-warning');
        const criticalIcon = createMarkerIcon('#e74c3c', 'marker-pulse-critical');

        // Sample IoT stations data (247 stations across Guinea)
        const stations = [
            // Kindia Region (40 stations)
            { name: "Station Kindia-01", lat: 10.0571, lng: -12.8642, region: "Kindia", status: "active", temp: 28.5, humidity: 76, soil: 24.3, crop: "Ananas" },
            { name: "Station Kindia-02", lat: 10.1234, lng: -12.7890, region: "Kindia", status: "active", temp: 27.8, humidity: 78, soil: 25.1, crop: "Ananas" },
            { name: "Station Kindia-03", lat: 9.9876, lng: -12.9123, region: "Kindia", status: "warning", temp: 29.2, humidity: 82, soil: 22.5, crop: "Riz" },
            { name: "Station Kindia-04", lat: 10.2345, lng: -12.6789, region: "Kindia", status: "active", temp: 28.1, humidity: 75, soil: 26.0, crop: "Ananas" },
            { name: "Station Kindia-05", lat: 10.0123, lng: -12.8234, region: "Kindia", status: "active", temp: 27.9, humidity: 77, soil: 24.8, crop: "Manioc" },
            
            // Mamou Region (35 stations)
            { name: "Station Mamou-01", lat: 10.3759, lng: -12.0913, region: "Mamou", status: "active", temp: 26.5, humidity: 72, soil: 23.1, crop: "Ma√Øs" },
            { name: "Station Mamou-02", lat: 10.4567, lng: -12.0234, region: "Mamou", status: "warning", temp: 27.3, humidity: 74, soil: 21.8, crop: "Ma√Øs" },
            { name: "Station Mamou-03", lat: 10.2890, lng: -12.1567, region: "Mamou", status: "active", temp: 26.8, humidity: 73, soil: 22.9, crop: "Riz" },
            { name: "Station Mamou-04", lat: 10.5123, lng: -11.9876, region: "Mamou", status: "critical", temp: 28.9, humidity: 85, soil: 19.5, crop: "Ma√Øs" },
            
            // Lab√© Region (30 stations)
            { name: "Station Lab√©-01", lat: 11.3180, lng: -12.2895, region: "Lab√©", status: "active", temp: 25.2, humidity: 70, soil: 24.5, crop: "Riz" },
            { name: "Station Lab√©-02", lat: 11.4567, lng: -12.1234, region: "Lab√©", status: "active", temp: 24.8, humidity: 68, soil: 25.2, crop: "Ma√Øs" },
            { name: "Station Lab√©-03", lat: 11.2345, lng: -12.3567, region: "Lab√©", status: "warning", temp: 26.1, humidity: 75, soil: 23.8, crop: "Riz" },
            
            // Kankan Region (45 stations)
            { name: "Station Kankan-01", lat: 10.3853, lng: -9.3064, region: "Kankan", status: "critical", temp: 31.2, humidity: 94, soil: 18.3, crop: "Riz Bas-fond" },
            { name: "Station Kankan-02", lat: 10.4567, lng: -9.2234, region: "Kankan", status: "critical", temp: 30.8, humidity: 92, soil: 19.1, crop: "Riz Bas-fond" },
            { name: "Station Kankan-03", lat: 10.3123, lng: -9.3890, region: "Kankan", status: "warning", temp: 29.5, humidity: 88, soil: 20.5, crop: "Riz" },
            { name: "Station Kankan-04", lat: 10.5234, lng: -9.1567, region: "Kankan", status: "active", temp: 28.7, humidity: 82, soil: 22.3, crop: "Ma√Øs" },
            { name: "Station Kankan-05", lat: 10.2890, lng: -9.4123, region: "Kankan", status: "warning", temp: 30.1, humidity: 90, soil: 19.8, crop: "Riz Bas-fond" },
            
            // Faranah Region (25 stations)
            { name: "Station Faranah-01", lat: 10.0406, lng: -10.7430, region: "Faranah", status: "active", temp: 29.3, humidity: 78, soil: 23.5, crop: "Riz" },
            { name: "Station Faranah-02", lat: 10.1234, lng: -10.6567, region: "Faranah", status: "active", temp: 28.9, humidity: 76, soil: 24.1, crop: "Ma√Øs" },
            { name: "Station Faranah-03", lat: 9.9567, lng: -10.8234, region: "Faranah", status: "warning", temp: 30.2, humidity: 82, soil: 22.3, crop: "Riz" },
            
            // Bok√© Region (35 stations)
            { name: "Station Bok√©-01", lat: 10.9424, lng: -14.2919, region: "Bok√©", status: "active", temp: 27.5, humidity: 74, soil: 25.8, crop: "Riz" },
            { name: "Station Bok√©-02", lat: 11.0234, lng: -14.2123, region: "Bok√©", status: "active", temp: 27.2, humidity: 72, soil: 26.2, crop: "Ma√Øs" },
            { name: "Station Bok√©-03", lat: 10.8567, lng: -14.3678, region: "Bok√©", status: "warning", temp: 28.4, humidity: 79, soil: 24.5, crop: "Riz" },
            
            // N'Z√©r√©kor√© Region (37 stations)
            { name: "Station N'Z√©r√©kor√©-01", lat: 7.7562, lng: -8.8179, region: "N'Z√©r√©kor√©", status: "active", temp: 26.8, humidity: 81, soil: 27.3, crop: "Riz" },
            { name: "Station N'Z√©r√©kor√©-02", lat: 7.8234, lng: -8.7345, region: "N'Z√©r√©kor√©", status: "active", temp: 26.5, humidity: 80, soil: 27.8, crop: "Manioc" },
            { name: "Station N'Z√©r√©kor√©-03", lat: 7.6890, lng: -8.8912, region: "N'Z√©r√©kor√©", status: "active", temp: 27.1, humidity: 82, soil: 26.9, crop: "Riz" },
        ];

        // Generate additional stations to reach 247 total
        const regions = [
            { name: "Kindia", center: [10.0571, -12.8642], count: 35 },
            { name: "Mamou", center: [10.3759, -12.0913], count: 31 },
            { name: "Lab√©", center: [11.3180, -12.2895], count: 27 },
            { name: "Kankan", center: [10.3853, -9.3064], count: 40 },
            { name: "Faranah", center: [10.0406, -10.7430], count: 22 },
            { name: "Bok√©", center: [10.9424, -14.2919], count: 32 },
            { name: "N'Z√©r√©kor√©", center: [7.7562, -8.8179], count: 34 }
        ];

        const crops = ["Riz", "Ma√Øs", "Ananas", "Manioc", "Riz Bas-fond", "Riz Plaine"];
        const statuses = ["active", "active", "active", "active", "active", "warning", "active", "active"];

        regions.forEach(region => {
            for (let i = 0; i < region.count; i++) {
                const randomLat = region.center[0] + (Math.random() - 0.5) * 0.8;
                const randomLng = region.center[1] + (Math.random() - 0.5) * 0.8;
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                stations.push({
                    name: `Station ${region.name}-${String(i + 6).padStart(2, '0')}`,
                    lat: randomLat,
                    lng: randomLng,
                    region: region.name,
                    status: status,
                    temp: 25 + Math.random() * 6,
                    humidity: 68 + Math.random() * 25,
                    soil: 18 + Math.random() * 10,
                    crop: crops[Math.floor(Math.random() * crops.length)]
                });
            }
        });

        // Add markers to map
        stations.forEach(station => {
            let icon, statusClass, statusText;
            
            if (station.status === 'critical') {
                icon = criticalIcon;
                statusClass = 'status-critical';
                statusText = 'CRITIQUE';
            } else if (station.status === 'warning') {
                icon = warningIcon;
                statusClass = 'status-warning';
                statusText = 'ALERTE';
            } else {
                icon = activeIcon;
                statusClass = 'status-active';
                statusText = 'ACTIF';
            }

            const marker = L.marker([station.lat, station.lng], { icon: icon }).addTo(map);

            const popupContent = `
                <div class="station-popup">
                    <h3>üìç ${station.name}</h3>
                    <div class="station-info">
                        <strong>R√©gion:</strong> ${station.region}<br>
                        <strong>Culture:</strong> ${station.crop}<br>
                        <strong>Temp√©rature:</strong> ${station.temp.toFixed(1)}¬∞C<br>
                        <strong>Humidit√©:</strong> ${station.humidity.toFixed(0)}%<br>
                        <strong>Humidit√© Sol:</strong> ${station.soil.toFixed(1)}%<br>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);

            // Add hover effect
            marker.on('mouseover', function() {
                this.getElement().style.transform = 'scale(1.3)';
            });
            marker.on('mouseout', function() {
                this.getElement().style.transform = 'scale(1)';
            });
        });

        // Update stats
        const activeCount = stations.filter(s => s.status === 'active').length;
        const warningCount = stations.filter(s => s.status === 'warning').length;
        const criticalCount = stations.filter(s => s.status === 'critical').length;

        document.getElementById('totalStations').textContent = stations.length;
        document.getElementById('activeStations').textContent = activeCount;
        document.getElementById('warningStations').textContent = warningCount;
        document.getElementById('criticalStations').textContent = criticalCount;

        // Add scale control
        L.control.scale({ imperial: false, metric: true }).addTo(map);

        console.log(`‚úÖ Carte charg√©e avec ${stations.length} stations IoT`);
    </script>
</body>
</html>